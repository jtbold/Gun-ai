<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>BFI Equipment Report Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background:#f3f4f6; }
    .container { max-width: 900px; }
    .no-break { white-space: nowrap; }
    #report-header { display:flex; flex-direction:column; align-items:center; padding-bottom:1rem; border-bottom:2px solid #e5e7eb; margin-bottom:1rem; }
  </style>
</head>

<body class="min-h-screen p-4 flex flex-col items-center">
  <div class="container bg-white rounded-3xl shadow-xl p-8 space-y-8">
    <header class="text-center space-y-3">
      <div class="flex items-center justify-center gap-3">
        <!-- logo file should live next to index.html in your repo -->
        <img id="bfi-logo" src="bona-fide-iron-logo.jpg" alt="Bona Fide Iron" class="h-14 w-auto rounded" />
        <div class="text-left">
          <div class="text-xl font-extrabold text-gray-900">Bona Fide Iron</div>
          <div class="text-sm text-gray-500">AI Valuation Engine</div>
        </div>
      </div>

      <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Construction Equipment Report Generator</h1>
      <p class="text-gray-500">
        Upload up to <strong>20</strong> photos to generate a professional identification + valuation + deal analysis report.
      </p>
      <p id="user-id" class="text-xs text-gray-400"></p>
    </header>

    <!-- Upload -->
    <div id="drop-zone" class="w-full rounded-2xl border-4 border-dashed border-gray-300 p-8 text-center transition-colors hover:border-gray-400">
      <input type="file" id="file-input" class="hidden" accept="image/*" multiple>
      <div class="text-lg font-medium text-gray-700">Drag & drop, paste (Ctrl+V), or click to upload images</div>
      <p class="text-sm text-gray-400 mt-2">Maximum of 20 images, up to 6MB each.</p>
      <button id="upload-button" class="mt-6 px-6 py-3 bg-gray-900 text-white font-semibold rounded-xl hover:bg-gray-700 transition-colors">
        Choose Images
      </button>
    </div>

    <!-- Optional listing details (helps the rules engine) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="space-y-2">
        <label class="text-sm font-medium text-gray-700">Seller Asking Price (USD) — optional</label>
        <input id="asking-price" type="number" min="0" step="100"
               placeholder="e.g., 107000"
               class="w-full rounded-xl p-3 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
        <p class="text-xs text-gray-400">If blank, the app will still value it, but deal scoring will be limited.</p>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-medium text-gray-700">Operating Hours — optional</label>
        <input id="hours" type="number" min="0" step="10"
               placeholder="e.g., 8200"
               class="w-full rounded-xl p-3 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
        <p class="text-xs text-gray-400">If unknown, we skip hours depreciation and flag “manual review”.</p>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-medium text-gray-700">Region — optional (defaults Mountain West)</label>
        <select id="region" class="w-full rounded-xl p-3 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="">Auto / Default</option>
          <option value="Mountain West">Mountain West (CO/WY/MT)</option>
          <option value="Texas/Oklahoma">Texas/Oklahoma</option>
          <option value="California">California</option>
          <option value="Pacific Northwest">Pacific Northwest</option>
          <option value="Midwest">Midwest</option>
          <option value="Southeast">Southeast</option>
          <option value="Northeast">Northeast</option>
        </select>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-medium text-gray-700">Distance from Denver (miles) — optional</label>
        <input id="distance" type="number" min="0" step="10"
               placeholder="e.g., 250"
               class="w-full rounded-xl p-3 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
        <p class="text-xs text-gray-400">Used for transport adjustment.</p>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-medium text-gray-700">Days on Market — optional</label>
        <input id="days-on-market" type="number" min="0" step="1"
               placeholder="e.g., 28"
               class="w-full rounded-xl p-3 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-medium text-gray-700">Inventory Count (same model) — optional</label>
        <input id="inventory-count" type="number" min="0" step="1"
               placeholder="e.g., 2"
               class="w-full rounded-xl p-3 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
      </div>

      <div class="space-y-2 md:col-span-2">
        <label class="text-sm font-medium text-gray-700">Title / Documentation — optional</label>
        <select id="title-status" class="w-full rounded-xl p-3 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="">Unknown</option>
          <option value="Clean">Clean / OK</option>
          <option value="OutOfState">Out-of-state title</option>
          <option value="Lien">Lien holder listed</option>
          <option value="Rebuilt">Rebuilt title</option>
          <option value="Salvage">Salvage title</option>
          <option value="NoTitle">No title available</option>
        </select>
      </div>
    </div>

    <!-- Notes -->
    <div class="w-full">
      <div class="flex flex-col gap-3">
        <label for="notes-input" class="text-sm font-medium text-gray-700">
          Optional notes (serial, attachments, recent overhaul, issues, location, listing link, etc.)
        </label>
        <textarea id="notes-input" rows="4"
                  class="rounded-xl p-3 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
      </div>
    </div>

    <!-- Previews -->
    <div id="image-previews" class="flex flex-wrap gap-4 justify-center items-center p-4 rounded-xl bg-gray-50 shadow-inner" style="display:none;"></div>

    <!-- Actions -->
    <div class="flex flex-col items-center justify-center space-y-4">
      <button id="generate-button" class="w-full px-8 py-4 bg-indigo-600 text-white font-bold text-lg rounded-2xl shadow-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
        Generate Report
      </button>

      <button id="download-button" class="w-full px-8 py-4 bg-gray-600 text-white font-bold text-lg rounded-2xl shadow-lg hover:bg-gray-700 transition-colors hidden">
        Download Report (PDF)
      </button>

      <div id="status-message" class="text-sm text-center text-gray-600"></div>
    </div>

    <!-- Report -->
    <div id="report-container" class="w-full bg-white rounded-2xl shadow-lg p-6 space-y-6" style="display:none;">
      <div id="report-header" class="space-y-2">
        <img src="bona-fide-iron-logo.jpg" alt="Bona Fide Iron" class="h-12 w-auto rounded" />
        <h2 class="text-2xl font-bold text-gray-900">Equipment Identification & Valuation Report</h2>
        <div id="report-meta" class="text-xs text-gray-500"></div>
      </div>

      <div id="report-content" class="space-y-4"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables provided by the environment (Canvas / hosted)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // ***************************************************************
    // CRITICAL SECURITY: The API key is set to an empty string.
    // This line MUST be replaced by the build script (render_build.sh).
    const API_KEY = "";
    // ***************************************************************

    // -------------------------
    // BFI RULE ENGINE CONSTANTS
    // -------------------------

    // Regional multipliers (Colorado base = 1.00) :contentReference[oaicite:7]{index=7}
    const REGION_MULTIPLIERS = {
      "Mountain West": 1.00,
      "Texas/Oklahoma": 1.10,      // choose midpoint of +8% to +12%
      "California": 1.08,          // choose midpoint of +5% to +10%
      "Pacific Northwest": 1.04,   // choose midpoint of +3% to +5%
      "Midwest": 0.94,             // choose midpoint of -5% to -8%
      "Southeast": 1.02,           // choose midpoint of 0% to +3%
      "Northeast": 0.985           // choose midpoint of -3% to 0%
    };

    // Distance-based adjustment (uses the “Valuation Adjustment” numbers) :contentReference[oaicite:8]{index=8}
    function distanceAdjustmentUSD(distanceMiles) {
      if (distanceMiles === null || distanceMiles === undefined || isNaN(distanceMiles)) return null;
      if (distanceMiles <= 100) return -650;
      if (distanceMiles <= 300) return -1500;
      if (distanceMiles <= 500) return -2750;
      if (distanceMiles <= 800) return -4250;
      return null; // >800 -> manual review per rules
    }

    // Seasonal adjustments :contentReference[oaicite:9]{index=9}
    function currentSeasonAdjustmentPct() {
      const now = new Date();
      const m = now.getMonth() + 1;
      // Spring: Mar-May, Summer: Jun-Aug, Fall: Sep-Nov, Winter: Dec-Feb
      if (m >= 3 && m <= 5) return 0.065;     // midpoint of +5% to +8%
      if (m >= 6 && m <= 8) return 0.04;      // midpoint of +3% to +5%
      if (m >= 9 && m <= 11) return 0.0;      // baseline
      return -0.075;                          // midpoint of -5% to -10%
    }

    function seasonName() {
      const m = (new Date()).getMonth() + 1;
      if (m >= 3 && m <= 5) return "Spring";
      if (m >= 6 && m <= 8) return "Summer";
      if (m >= 9 && m <= 11) return "Fall";
      return "Winter";
    }

    // Inventory saturation penalties :contentReference[oaicite:10]{index=10}
    function saturationPenaltyPct(inventoryCount) {
      if (inventoryCount === null || inventoryCount === undefined || isNaN(inventoryCount)) return null;
      if (inventoryCount <= 2) return 0.0;
      if (inventoryCount <= 4) return -0.05;
      if (inventoryCount <= 6) return -0.10;
      return -0.20; // >6 => -20% or decline (we apply penalty and flag)
    }

    // Title/documentation rules :contentReference[oaicite:11]{index=11}
    function titleRule(titleStatus) {
      // returns { decision: "OK"|"DECLINE"|"FLAG", adjustmentUSD, adjustmentPct, notes[] }
      const out = { decision:"OK", adjustmentUSD:0, adjustmentPct:0, notes:[] };
      if (!titleStatus) return out;

      if (titleStatus === "NoTitle" || titleStatus === "Salvage") {
        out.decision = "DECLINE";
        out.notes.push("Title status triggers DECLINE under BFI rules.");
        return out;
      }
      if (titleStatus === "Rebuilt") {
        out.decision = "FLAG";
        out.adjustmentPct = -0.25; // “-25% minimum or decline”
        out.notes.push("Rebuilt title: -25% minimum adjustment or decline.");
        return out;
      }
      if (titleStatus === "OutOfState") {
        out.decision = "OK";
        out.adjustmentUSD = -500; // “Add $500 for title transfer costs”
        out.notes.push("Out-of-state title: -$500 transfer cost.");
        return out;
      }
      if (titleStatus === "Lien") {
        out.decision = "FLAG";
        out.notes.push("Lien holder listed: verify lien release before purchase.");
        return out;
      }
      return out;
    }

    // Hours depreciation tables :contentReference[oaicite:12]{index=12}
    const LIFESPAN_BY_TYPE = {
      "Excavator (standard)": { lifespan: 10000, highThreshold: 8000, ratePer500: -0.02 },
      "Excavator (heavy duty)": { lifespan: 15000, highThreshold: 12000, ratePer500: -0.02 },
      "Dozer": { lifespan: 12000, highThreshold: 10000, ratePer500: -0.025 },
      "Wheel loader": { lifespan: 10000, highThreshold: 8000, ratePer500: -0.02 },
      "Track loader": { lifespan: 8000, highThreshold: 6500, ratePer500: -0.025 },
      "Backhoe": { lifespan: 6000, highThreshold: 5000, ratePer500: -0.03 },
      "Skid steer": { lifespan: 5000, highThreshold: 4000, ratePer500: -0.03 }
    };

    // Hour-based penalty logic (percent-of-life) :contentReference[oaicite:13]{index=13}
    function hoursPenaltyPct(hours, lifespan) {
      if (hours === null || hours === undefined || isNaN(hours) || !lifespan) return null;
      const pct = hours / lifespan;
      if (pct <= 0.40) return +0.05;
      if (pct <= 0.60) return 0.0;
      if (pct <= 0.80) return -0.10;
      if (pct <= 1.00) return -0.25;
      return -0.40;
    }

    // Cross-validation safety margin when only 1–2 sources are available :contentReference[oaicite:14]{index=14}
    function limitedDataSafetyMarginPct(sourcesUsedCount) {
      if (sourcesUsedCount === null || sourcesUsedCount === undefined || isNaN(sourcesUsedCount)) return null;
      if (sourcesUsedCount <= 2) return -0.15;
      return 0.0;
    }

    // Priority scoring weights :contentReference[oaicite:15]{index=15}
    function priorityScore({ profitMarginPct, absoluteProfitUSD, confidencePct, marketVelocityScore, daysOnMarket }) {
      // Profit margin points: 20%=>40, 30%=>60, 40%=>80, 50%+=>100
      function marginPoints(p) {
        if (p === null || p === undefined || isNaN(p)) return 0;
        if (p >= 0.50) return 100;
        if (p >= 0.40) return 80;
        if (p >= 0.30) return 60;
        if (p >= 0.20) return 40;
        return Math.max(0, Math.round(p * 200)); // gentle scaling below 20%
      }

      // Absolute profit points: 10k=>50, 20k=>75, 30k+=>100
      function profitPoints(p) {
        if (p === null || p === undefined || isNaN(p)) return 0;
        if (p >= 30000) return 100;
        if (p >= 20000) return 75;
        if (p >= 10000) return 50;
        return Math.max(0, Math.round((p / 10000) * 50));
      }

      // Days on market points: >30 => 100, <7 => 25 (simple ramp)
      function domPoints(d) {
        if (d === null || d === undefined || isNaN(d)) return 50;
        if (d < 7) return 25;
        if (d > 30) return 100;
        // linear 7..30 => 40..95
        return Math.round(40 + (d - 7) * (55 / 23));
      }

      const mPts = marginPoints(profitMarginPct);
      const pPts = profitPoints(absoluteProfitUSD);
      const cPts = Math.max(0, Math.min(100, Math.round(confidencePct || 0)));
      const vPts = Math.max(0, Math.min(100, Math.round(marketVelocityScore || 50)));
      const dPts = domPoints(daysOnMarket);

      const score =
        (mPts * 0.40) +
        (pPts * 0.30) +
        (cPts * 0.15) +
        (vPts * 0.10) +
        (dPts * 0.05);

      return Math.round(score * 10) / 10;
    }

    function priorityTier(score) {
      if (score >= 90) return "CRITICAL";
      if (score >= 75) return "HIGH";
      if (score >= 60) return "MEDIUM";
      if (score >= 40) return "LOW";
      return "PASS";
    }

    // ---------------
    // App state
    // ---------------
    let reportData = null;
    let selectedFiles = [];
    let originalFiles = [];

    // Firebase
    let app, db = null, auth, userId;
    let isAuthReady = false;

    async function initFirebase() {
      try {
        if (Object.keys(firebaseConfig).length === 0) {
          isAuthReady = true;
          userId = crypto.randomUUID();
          document.getElementById('user-id').textContent = `User ID: (Local) ${userId.substring(0, 8)}...`;
          return;
        }
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
        else await signInAnonymously(auth);

        userId = auth.currentUser.uid;
        document.getElementById('user-id').textContent = `User ID: ${userId}`;
        isAuthReady = true;
      } catch (e) {
        console.error("Firebase init error:", e);
        db = null;
        isAuthReady = true; // allow app to run even without db
        document.getElementById('status-message').textContent = "Database unavailable (local mode).";
      }
    }
    initFirebase();

    // DOM
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadButton = document.getElementById('upload-button');
    const notesInput = document.getElementById('notes-input');
    const generateButton = document.getElementById('generate-button');
    const downloadButton = document.getElementById('download-button');
    const imagePreviewsContainer = document.getElementById('image-previews');
    const statusMessage = document.getElementById('status-message');
    const reportContainer = document.getElementById('report-container');
    const reportContent = document.getElementById('report-content');
    const reportMeta = document.getElementById('report-meta');

    const askingPriceEl = document.getElementById('asking-price');
    const hoursEl = document.getElementById('hours');
    const regionEl = document.getElementById('region');
    const distanceEl = document.getElementById('distance');
    const domEl = document.getElementById('days-on-market');
    const inventoryEl = document.getElementById('inventory-count');
    const titleEl = document.getElementById('title-status');

    // Limits
    const MAX_FILES = 20;
    const MAX_FILE_SIZE_MB = 6;

    // Image processing:
    // - For model: keep analysis stable (max 1024 side, jpeg)
    // - For PDF: make smaller (target width ~3 inches = 76mm on A4), lower quality
    const MAX_IMAGE_SIDE_PX_MODEL = 1024;
    const UNSUPPORTED_MIME_TYPES = ['image/avif', 'image/svg+xml'];

    function showMessage(message, type = 'info') {
      statusMessage.className = `text-sm text-center mt-4 ${type === 'error' ? 'text-red-600' : 'text-gray-600'}`;
      statusMessage.textContent = message;
    }

    function toggleGenerateButton() {
      generateButton.disabled = selectedFiles.length === 0;
      if (selectedFiles.length === 0 && !reportData) downloadButton.classList.add('hidden');
    }

    function showPreviews() {
      imagePreviewsContainer.innerHTML = '';
      if (selectedFiles.length > 0) {
        imagePreviewsContainer.style.display = 'flex';
        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const imgWrapper = document.createElement('div');
            imgWrapper.className = 'relative group w-28 h-28 rounded-lg overflow-hidden shadow-md';
            imgWrapper.innerHTML = `
              <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-full object-cover">
              <button class="absolute top-1 right-1 bg-black/50 text-white rounded-full p-1 leading-none text-sm opacity-0 group-hover:opacity-100 transition-opacity" data-index="${index}">
                &times;
              </button>
            `;
            imagePreviewsContainer.appendChild(imgWrapper);
          };
          reader.readAsDataURL(file);
        });
      } else {
        imagePreviewsContainer.style.display = 'none';
      }
    }

    function processFiles(files) {
      let newFiles = Array.from(files).filter(file => {
        const mt = (file.type || '').toLowerCase();
        if (!mt.startsWith('image/')) { showMessage(`"${file.name}" is not an image.`, 'error'); return false; }
        if (UNSUPPORTED_MIME_TYPES.includes(mt)) { showMessage(`"${file.name}" is an unsupported format. Use JPG/PNG.`, 'error'); return false; }
        if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) { showMessage(`"${file.name}" exceeds ${MAX_FILE_SIZE_MB}MB.`, 'error'); return false; }
        return true;
      });

      if (selectedFiles.length + newFiles.length > MAX_FILES) {
        const limit = MAX_FILES - selectedFiles.length;
        newFiles = newFiles.slice(0, limit);
        showMessage(`Max ${MAX_FILES} images. Added ${limit}.`, 'error');
      }

      selectedFiles = [...selectedFiles, ...newFiles].slice(0, MAX_FILES);
      showPreviews();
      toggleGenerateButton();
      if (newFiles.length) showMessage(`Added ${newFiles.length} image(s). Total: ${selectedFiles.length}/${MAX_FILES}`);
    }

    // Resize for model stability
    function resizeForModel(file) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          if (w > MAX_IMAGE_SIDE_PX_MODEL || h > MAX_IMAGE_SIDE_PX_MODEL) {
            const r = Math.max(w / MAX_IMAGE_SIDE_PX_MODEL, h / MAX_IMAGE_SIDE_PX_MODEL);
            w = Math.round(w / r); h = Math.round(h / r);
          }
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          canvas.toBlob(blob => {
            resolve(new File([blob], file.name.replace(/\.\w+$/, '') + ".jpg", { type: 'image/jpeg' }));
          }, 'image/jpeg', 0.85);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    // Events
    uploadButton.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => { processFiles(e.target.files); e.target.value=''; });

    dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.classList.add('border-gray-500','bg-gray-50'); });
    dropZone.addEventListener('dragleave', (e)=>{ e.preventDefault(); dropZone.classList.remove('border-gray-500','bg-gray-50'); });
    dropZone.addEventListener('drop', (e)=>{ e.preventDefault(); dropZone.classList.remove('border-gray-500','bg-gray-50'); processFiles(e.dataTransfer.files); });

    window.addEventListener('paste', (e) => {
      const items = e.clipboardData.items;
      const files = [];
      for (let i=0;i<items.length;i++) {
        if (items[i].kind === 'file' && items[i].type.startsWith('image/')) files.push(items[i].getAsFile());
      }
      if (files.length) processFiles(files);
    });

    imagePreviewsContainer.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        const idx = Number(e.target.getAttribute('data-index'));
        selectedFiles.splice(idx, 1);
        showPreviews();
        toggleGenerateButton();
        showMessage(`Removed image ${idx+1}.`);
      }
    });

    // Helpers
    const fmtUSD = (n) => {
      if (n === null || n === undefined || isNaN(n)) return "N/A";
      return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits:0 }).format(n);
    };
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const safeNum = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };

    function computeBFIValuation(inputs) {
      // inputs includes: baseMarketValueUSD, sourcesUsedCount, sourcesSpreadPct, conditionAdjUSD, conditionTier, conditionConfidencePct,
      // equipmentTypeBucket, hours, region, distanceMiles, inventoryCount, daysOnMarket, titleStatus, reconCostUSD, riskAdjUSD, marketVelocityScore, aiConfidencePct
      const notes = [];
      const flags = [];
      let decision = "OK"; // OK / FLAG / DECLINE

      // 0) Title rules first (hard stops) :contentReference[oaicite:16]{index=16}
      const t = titleRule(inputs.titleStatus);
      if (t.decision === "DECLINE") {
        return {
          decision: "DECLINE",
          notes: [...t.notes],
          flags: ["DECLINE"],
          breakdown: {},
          deal: {}
        };
      }
      if (t.decision === "FLAG") { decision = "FLAG"; flags.push("MANUAL_REVIEW"); notes.push(...t.notes); }
      let titleAdjUSD = t.adjustmentUSD || 0;
      let titleAdjPct = t.adjustmentPct || 0;

      // 1) Base Market Value + cross-validation safety margin :contentReference[oaicite:17]{index=17}
      let base = inputs.baseMarketValueUSD;
      if (base === null) {
        decision = "FLAG";
        flags.push("MANUAL_REVIEW");
        notes.push("No comparable data found: unable to value automatically.");
        return {
          decision: "FLAG",
          notes,
          flags,
          breakdown: { baseMarketValueUSD: null },
          deal: {}
        };
      }

      const spread = inputs.sourcesSpreadPct;
      const srcCount = inputs.sourcesUsedCount;

      if (spread !== null) {
        if (spread <= 10) {
          // high confidence path: use as-is
        } else if (spread <= 20) {
          decision = "FLAG";
          flags.push("MANUAL_REVIEW");
          notes.push("Sources vary 10–20%: flagged for review.");
        } else {
          decision = "FLAG";
          flags.push("MANUAL_REVIEW");
          notes.push("Sources vary >20%: use conservative estimate and require manual review.");
          // conservative estimate: shave 10% off base
          base = base * 0.90;
        }
      }

      const safetyMarginPct = limitedDataSafetyMarginPct(srcCount);
      let safetyAdj = 0;
      if (safetyMarginPct !== null && safetyMarginPct < 0) {
        safetyAdj = base * safetyMarginPct;
        decision = "FLAG";
        flags.push("MANUAL_REVIEW");
        notes.push("Limited data (1–2 sources): applied 15% safety margin and flagged for review.");
      }

      // 2) Condition assessment adjustment (USD) :contentReference[oaicite:18]{index=18}
      let conditionAdjUSD = inputs.conditionAdjustmentsUSD ?? null;
      if (conditionAdjUSD === null) {
        decision = "FLAG";
        flags.push("MANUAL_REVIEW");
        notes.push("Condition adjustment missing: flagged for manual review.");
        conditionAdjUSD = 0;
      }

      // 3) Hours depreciation :contentReference[oaicite:19]{index=19}
      let hoursAdjPct = null;
      let hoursAdjUSD = 0;
      if (inputs.hours !== null && inputs.equipmentTypeBucket && LIFESPAN_BY_TYPE[inputs.equipmentTypeBucket]) {
        const life = LIFESPAN_BY_TYPE[inputs.equipmentTypeBucket].lifespan;
        hoursAdjPct = hoursPenaltyPct(inputs.hours, life);
        hoursAdjUSD = (base + safetyAdj + conditionAdjUSD) * (hoursAdjPct || 0);
      } else {
        // If hours missing, rules say flag for review when data unclear
        decision = "FLAG";
        flags.push("MANUAL_REVIEW");
        notes.push("Hours and/or equipment type not available: hours depreciation skipped; manual review recommended.");
      }

      // 4) Geographic multiplier :contentReference[oaicite:20]{index=20}
      const region = inputs.region || "Mountain West";
      const regionMult = REGION_MULTIPLIERS[region] ?? 1.00;
      const geoAdjUSD = (base + safetyAdj) * (regionMult - 1.0);

      // 5) Market factors: seasonal + saturation :contentReference[oaicite:21]{index=21}
      const seasonPct = currentSeasonAdjustmentPct();
      const seasonAdjUSD = (base + safetyAdj) * seasonPct;

      const satPct = saturationPenaltyPct(inputs.inventoryCount);
      let satAdjUSD = 0;
      if (satPct !== null) {
        satAdjUSD = (base + safetyAdj) * satPct;
        if (inputs.inventoryCount > 6) {
          decision = "FLAG";
          flags.push("MANUAL_REVIEW");
          notes.push("Inventory >6: critical saturation risk; manual review recommended.");
        }
      } else {
        notes.push("Inventory count missing: saturation rule skipped.");
      }

      // 6) Distance-based transport adjustment :contentReference[oaicite:22]{index=22}
      let distAdjUSD = 0;
      const distAdj = distanceAdjustmentUSD(inputs.distanceMiles);
      if (distAdj === null && inputs.distanceMiles !== null) {
        decision = "FLAG";
        flags.push("MANUAL_REVIEW");
        notes.push("Distance >800 miles: flagged for manual review (transport likely unprofitable).");
      } else if (distAdj !== null) {
        distAdjUSD = distAdj;
      } else {
        notes.push("Distance missing: transport adjustment skipped.");
      }

      // 7) Risk adjustments (USD) :contentReference[oaicite:23]{index=23}
      let riskAdjUSD = inputs.riskAdjustmentsUSD ?? 0;
      if (inputs.riskFlags?.includes("STRUCTURAL_DAMAGE")) {
        decision = "FLAG";
        flags.push("MANUAL_REVIEW");
        notes.push("Structural damage risk: decline or expert review recommended.");
      }

      // 8) Title adjustments (pct/usd)
      const titlePctUSD = (base + safetyAdj) * (titleAdjPct || 0);

      // --- Build values ---
      // “Projected Retail” = base market (geo adjusted) (matches example structure where projected retail = base market) :contentReference[oaicite:24]{index=24}
      const projectedRetailUSD = Math.max(0, Math.round((base + safetyAdj + geoAdjUSD)));

      // Wholesale target (“our offer”) starts from: base + safety + geo + condition + hours + market factors + risk + title + distance
      const wholesaleUSD_raw =
        (base + safetyAdj + geoAdjUSD) +
        conditionAdjUSD +
        hoursAdjUSD +
        seasonAdjUSD +
        satAdjUSD +
        riskAdjUSD +
        titleAdjUSD +
        titlePctUSD +
        distAdjUSD;

      const wholesaleTargetUSD = Math.max(0, Math.round(wholesaleUSD_raw));

      // Deal analysis (if asking price known) :contentReference[oaicite:25]{index=25}
      const asking = inputs.askingPriceUSD;
      const recon = inputs.reconditioningUSD ?? null;

      let transportCostUSD = null;
      // We approximate transport cost from distance bucket (not perfect, but aligned with the same buckets)
      if (inputs.distanceMiles !== null && !isNaN(inputs.distanceMiles)) {
        if (inputs.distanceMiles <= 100) transportCostUSD = 650;
        else if (inputs.distanceMiles <= 300) transportCostUSD = 1500;
        else if (inputs.distanceMiles <= 500) transportCostUSD = 2750;
        else if (inputs.distanceMiles <= 800) transportCostUSD = 4250;
      }

      let totalInvestmentUSD = null;
      let netProfitUSD = null;
      let profitMarginPct = null;

      if (asking !== null) {
        const tCost = transportCostUSD ?? 0;
        const rCost = recon ?? 0;
        totalInvestmentUSD = asking + tCost + rCost;
        netProfitUSD = projectedRetailUSD - totalInvestmentUSD;
        profitMarginPct = totalInvestmentUSD > 0 ? (netProfitUSD / totalInvestmentUSD) : null;
      } else {
        notes.push("Asking price missing: profit and priority score are limited.");
      }

      const score = priorityScore({
        profitMarginPct,
        absoluteProfitUSD: netProfitUSD,
        confidencePct: inputs.aiConfidencePct ?? 0,
        marketVelocityScore: inputs.marketVelocityScore ?? 50,
        daysOnMarket: inputs.daysOnMarket
      });

      return {
        decision,
        notes,
        flags,
        breakdown: {
          baseMarketValueUSD: Math.round(base),
          safetyMarginAdjUSD: Math.round(safetyAdj),
          geoRegion: region,
          geoMultiplier: regionMult,
          geoAdjUSD: Math.round(geoAdjUSD),
          conditionTier: inputs.conditionTier || "Unknown",
          conditionAdjUSD: Math.round(conditionAdjUSD),
          hours: inputs.hours,
          equipmentTypeBucket: inputs.equipmentTypeBucket || "Unknown",
          hoursAdjPct: hoursAdjPct,
          hoursAdjUSD: Math.round(hoursAdjUSD),
          season: seasonName(),
          seasonAdjUSD: Math.round(seasonAdjUSD),
          inventoryCount: inputs.inventoryCount,
          saturationAdjUSD: Math.round(satAdjUSD),
          distanceMiles: inputs.distanceMiles,
          distanceAdjUSD: Math.round(distAdjUSD),
          titleStatus: inputs.titleStatus || "Unknown",
          titleAdjUSD: Math.round(titleAdjUSD + titlePctUSD),
          riskAdjUSD: Math.round(riskAdjUSD),
          projectedRetailUSD,
          wholesaleTargetUSD
        },
        deal: {
          askingPriceUSD: asking,
          transportCostUSD,
          reconditioningUSD: recon,
          totalInvestmentUSD,
          netProfitUSD,
          profitMarginPct,
          priorityScore: score,
          priorityTier: priorityTier(score)
        }
      };
    }

    // -------------------------
    // LLM call + report rendering
    // -------------------------
    generateButton.addEventListener('click', async () => {
      if (!API_KEY) { showMessage("API Key is missing. Please set your new API key.", 'error'); return; }
      if (!isAuthReady) { showMessage("Database status unknown. Please wait a moment.", 'error'); return; }
      if (!selectedFiles.length) { showMessage("Add at least one photo.", 'error'); return; }

      showMessage("Generating report... analyzing photos and pulling grounded market data.", 'info');
      generateButton.disabled = true;
      downloadButton.classList.add('hidden');
      reportContainer.style.display = 'none';
      reportData = null;

      originalFiles = [...selectedFiles];

      try {
        // Prepare images
        showMessage("Step 1/3: preparing images...", 'info');
        const resizedFiles = await Promise.all(originalFiles.map(f => resizeForModel(f)));

        const base64Images = await Promise.all(resizedFiles.map(file => new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onloadend = () => {
            const dataUrl = r.result;
            const b64 = dataUrl.split(',')[1];
            resolve({ data: b64, mimeType: 'image/jpeg' });
          };
          r.onerror = reject;
          r.readAsDataURL(file);
        })));

        // Gather optional user fields
        const askingPriceUSD = safeNum(askingPriceEl.value);
        const hours = safeNum(hoursEl.value);
        const region = regionEl.value || null;
        const distanceMiles = safeNum(distanceEl.value);
        const daysOnMarket = safeNum(domEl.value);
        const inventoryCount = safeNum(inventoryEl.value);
        const titleStatus = titleEl.value || null;

        const userNotes = (notesInput.value || "").trim();

        // Prompt: force structured outputs so our rule engine can operate even when missing
        showMessage("Step 2/3: calling model...", 'info');

        const reportPrompt = `
You are a heavy equipment inspector + valuation analyst for Bona Fide Iron.

Your job:
(1) Identify the equipment from photos.
(2) Estimate a Base Market Value using real-time web grounding (Google Search tool).
(3) Return clean JSON only (no markdown) in the exact schema below.

IMPORTANT:
- If a field cannot be determined from photos + notes + grounded search, set it to null (do not guess).
- Values that are money must be NUMBERS in USD (no $, no commas, no ranges).
- Provide "sourcesUsedCount" and "sourcesSpreadPct" based on the grounded research you performed.
- "conditionAdjustmentsUSD" should be the total dollar adjustment from condition findings you observe.
- "riskAdjustmentsUSD" should be the total dollar adjustment for major risks you observe or verify via grounding.
- Include "riskFlags" as an array of strings when relevant (examples below).
- Keep narrative sections short and professional.

SCHEMA (return ONLY valid JSON):
{
  "equipment": {
    "category": "string (e.g., Excavator, Skid Steer, Dozer, Wheel Loader, Backhoe, Track Loader)",
    "make": "string|null",
    "model": "string|null",
    "year": "number|null",
    "serialNumber": "string|null",
    "configuration": "string|null",
    "attachments": "string|null"
  },
  "market": {
    "baseMarketValueUSD": "number|null",
    "sourcesUsedCount": "number|null",
    "sourcesSpreadPct": "number|null",
    "marketVelocityScore": "number|null"
  },
  "condition": {
    "conditionTier": "string|null (Excellent|Good|Fair|Poor|Unknown)",
    "conditionConfidencePct": "number|null",
    "conditionFindings": "string|null",
    "conditionAdjustmentsUSD": "number|null"
  },
  "hours": {
    "reportedHours": "number|null",
    "recentOverhaulWithin500hrs": "boolean|null"
  },
  "risks": {
    "riskSummary": "string|null",
    "riskFlags": "array (strings)",
    "riskAdjustmentsUSD": "number|null"
  },
  "reconditioning": {
    "estimatedReconditioningUSD": "number|null",
    "reconditioningNotes": "string|null"
  },
  "disclaimer": "string"
}

RISK FLAGS examples:
- "ENGINE_ISSUES"
- "HYDRAULIC_ISSUES"
- "TRANSMISSION_ISSUES"
- "STRUCTURAL_DAMAGE"
- "ELECTRICAL_ISSUES"
- "EMISSIONS_ISSUES"
- "RECALL_ACTIVE"
- "TITLE_PROBLEM"
`;

        const payload = {
          contents: [{
            parts: [
              { text: reportPrompt },
              { text: `User-entered listing fields (may be null): askingPriceUSD=${askingPriceUSD}, region=${region}, distanceMiles=${distanceMiles}, daysOnMarket=${daysOnMarket}, inventoryCountSameModel=${inventoryCount}, titleStatus=${titleStatus}` },
              { text: `User Notes: ${userNotes}` },
              ...base64Images.map(img => ({ inlineData: { mimeType: img.mimeType, data: img.data } }))
            ]
          }],
          tools: [{ "google_search": {} }]
        };

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
        const resp = await fetch(apiUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });

        if (!resp.ok) {
          const t = await resp.text();
          throw new Error(`API Error ${resp.status}: ${t}`);
        }

        const result = await resp.json();
        let jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!jsonText) throw new Error("Model returned empty response.");

        // Extract grounding sources (optional)
        let sources = [];
        const groundingMetadata = result.candidates?.[0]?.groundingMetadata;
        if (groundingMetadata?.groundingAttributions) {
          sources = groundingMetadata.groundingAttributions
            .map(a => ({ uri: a.web?.uri, title: a.web?.title }))
            .filter(s => s.uri && s.title);
        }

        // Parse JSON strictly
        jsonText = jsonText.trim();
        const firstBrace = jsonText.indexOf('{');
        const lastBrace = jsonText.lastIndexOf('}');
        if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) jsonText = jsonText.slice(firstBrace, lastBrace+1);

        let report;
        try { report = JSON.parse(jsonText); }
        catch (e) { console.error("Bad JSON:", jsonText); throw new Error("JSON parsing failed (model returned malformed JSON)."); }

        report.sources = sources;

        // Build rule inputs for engine
        const category = report?.equipment?.category || null;

        // Map to our rule buckets
        function mapBucket(cat) {
          if (!cat) return null;
          const c = cat.toLowerCase();
          if (c.includes("excavator")) return "Excavator (standard)";
          if (c.includes("dozer")) return "Dozer";
          if (c.includes("wheel") && c.includes("loader")) return "Wheel loader";
          if (c.includes("track") && c.includes("loader")) return "Track loader";
          if (c.includes("backhoe")) return "Backhoe";
          if (c.includes("skid")) return "Skid steer";
          return null;
        }

        const engineInputs = {
          baseMarketValueUSD: safeNum(report?.market?.baseMarketValueUSD),
          sourcesUsedCount: safeNum(report?.market?.sourcesUsedCount),
          sourcesSpreadPct: safeNum(report?.market?.sourcesSpreadPct),
          conditionTier: report?.condition?.conditionTier || null,
          conditionConfidencePct: safeNum(report?.condition?.conditionConfidencePct),
          conditionAdjustmentsUSD: safeNum(report?.condition?.conditionAdjustmentsUSD),
          equipmentTypeBucket: mapBucket(category),
          hours: hours ?? safeNum(report?.hours?.reportedHours),
          region: region ?? null,
          distanceMiles,
          inventoryCount,
          daysOnMarket,
          titleStatus,
          reconditioningUSD: safeNum(report?.reconditioning?.estimatedReconditioningUSD),
          riskAdjustmentsUSD: safeNum(report?.risks?.riskAdjustmentsUSD),
          riskFlags: Array.isArray(report?.risks?.riskFlags) ? report.risks.riskFlags : [],
          marketVelocityScore: safeNum(report?.market?.marketVelocityScore),
          aiConfidencePct: safeNum(report?.condition?.conditionConfidencePct) ?? 0,
          askingPriceUSD
        };

        const computed = computeBFIValuation(engineInputs);

        // Store combined report
        reportData = { raw: report, computed };

        // Render report
        reportMeta.textContent = `Generated: ${new Date().toLocaleString()} • Season: ${seasonName()} • Decision: ${computed.decision}`;

        const b = computed.breakdown;
        const d = computed.deal;

        const declineBanner = computed.decision === "DECLINE"
          ? `<div class="p-4 rounded-xl bg-red-50 border border-red-200 text-red-800">
              <div class="font-bold text-lg">DECLINE</div>
              <div class="text-sm">Title/documentation rules triggered a decline decision.</div>
            </div>`
          : "";

        const flagBanner = computed.decision === "FLAG"
          ? `<div class="p-4 rounded-xl bg-yellow-50 border border-yellow-200 text-yellow-900">
              <div class="font-bold text-lg">Manual Review Recommended</div>
              <div class="text-sm">One or more rule gates were triggered (limited data, high variance, missing inputs, distance >800, etc.).</div>
            </div>`
          : "";

        const sourcesHtml = (report.sources && report.sources.length)
          ? `<div class="text-xs text-gray-500 space-y-1">
              <div class="font-semibold text-gray-700">Grounded Sources (from model):</div>
              ${report.sources.slice(0,8).map(s => `<div>• ${s.title}</div>`).join('')}
            </div>`
          : `<div class="text-xs text-gray-500">No source metadata returned by the model.</div>`;

        const notesList = (computed.notes && computed.notes.length)
          ? `<ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">${computed.notes.map(n => `<li>${n}</li>`).join('')}</ul>`
          : `<div class="text-sm text-gray-600">No additional notes.</div>`;

        const idBlock = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 bg-gray-50 rounded-xl">
              <div class="text-sm text-gray-500">Equipment</div>
              <div class="text-lg font-bold text-gray-900">${(report.equipment?.year ?? "Year?")} ${(report.equipment?.make ?? "Make?")} ${(report.equipment?.model ?? "Model?")}</div>
              <div class="text-sm text-gray-700">${report.equipment?.category ?? "Category?"}${report.equipment?.configuration ? " • " + report.equipment.configuration : ""}</div>
              <div class="text-xs text-gray-500 mt-2">Serial: ${report.equipment?.serialNumber ?? "Unknown"}</div>
              <div class="text-xs text-gray-500">Attachments: ${report.equipment?.attachments ?? "Unknown"}</div>
            </div>

            <div class="p-4 bg-gray-50 rounded-xl">
              <div class="text-sm text-gray-500">Condition</div>
              <div class="text-lg font-bold text-gray-900">${report.condition?.conditionTier ?? "Unknown"}</div>
              <div class="text-sm text-gray-700">${report.condition?.conditionFindings ?? "No condition notes provided."}</div>
              <div class="text-xs text-gray-500 mt-2">Condition confidence: ${report.condition?.conditionConfidencePct ?? "N/A"}%</div>
            </div>
          </div>
        `;

        const valuationBlock = `
          <div class="p-4 rounded-2xl border bg-green-50">
            <div class="text-lg font-bold text-gray-900 mb-2">Valuation Summary</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="flex justify-between">
                <span class="text-gray-700">Projected Retail (market)</span>
                <span class="font-bold text-green-700 no-break">${fmtUSD(b.projectedRetailUSD)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-700">Wholesale Target (our offer)</span>
                <span class="font-bold text-blue-700 no-break">${fmtUSD(b.wholesaleTargetUSD)}</span>
              </div>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              Retail tracks base market value; offer reflects BFI rule adjustments (condition, hours, geo, season, saturation, risk, transport).
            </div>
          </div>
        `;

        const breakdownTable = `
          <div class="p-4 rounded-2xl border bg-white">
            <div class="text-lg font-bold text-gray-900 mb-3">Valuation Breakdown (Rule Engine)</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              <div class="flex justify-between"><span>Base Market Value</span><span class="font-semibold">${fmtUSD(b.baseMarketValueUSD)}</span></div>
              <div class="flex justify-between"><span>Safety Margin (limited data)</span><span class="font-semibold">${fmtUSD(b.safetyMarginAdjUSD)}</span></div>

              <div class="flex justify-between"><span>Geo Region / Multiplier</span><span class="font-semibold">${b.geoRegion} (${b.geoMultiplier})</span></div>
              <div class="flex justify-between"><span>Geo Adjustment</span><span class="font-semibold">${fmtUSD(b.geoAdjUSD)}</span></div>

              <div class="flex justify-between"><span>Condition Tier</span><span class="font-semibold">${b.conditionTier}</span></div>
              <div class="flex justify-between"><span>Condition Adjustment</span><span class="font-semibold">${fmtUSD(b.conditionAdjUSD)}</span></div>

              <div class="flex justify-between"><span>Hours / Type</span><span class="font-semibold">${b.hours ?? "Unknown"} / ${b.equipmentTypeBucket}</span></div>
              <div class="flex justify-between"><span>Hours Adjustment</span><span class="font-semibold">${(b.hoursAdjPct===null ? "N/A" : Math.round(b.hoursAdjPct*100)+"%")} (${fmtUSD(b.hoursAdjUSD)})</span></div>

              <div class="flex justify-between"><span>Season</span><span class="font-semibold">${b.season}</span></div>
              <div class="flex justify-between"><span>Season Adjustment</span><span class="font-semibold">${fmtUSD(b.seasonAdjUSD)}</span></div>

              <div class="flex justify-between"><span>Inventory (same model)</span><span class="font-semibold">${b.inventoryCount ?? "Unknown"}</span></div>
              <div class="flex justify-between"><span>Saturation Adjustment</span><span class="font-semibold">${fmtUSD(b.saturationAdjUSD)}</span></div>

              <div class="flex justify-between"><span>Distance (mi)</span><span class="font-semibold">${b.distanceMiles ?? "Unknown"}</span></div>
              <div class="flex justify-between"><span>Distance Adjustment</span><span class="font-semibold">${fmtUSD(b.distanceAdjUSD)}</span></div>

              <div class="flex justify-between"><span>Title Status</span><span class="font-semibold">${b.titleStatus}</span></div>
              <div class="flex justify-between"><span>Title Adjustment</span><span class="font-semibold">${fmtUSD(b.titleAdjUSD)}</span></div>

              <div class="flex justify-between"><span>Risk Adjustments</span><span class="font-semibold">${fmtUSD(b.riskAdjUSD)}</span></div>
              <div class="flex justify-between"><span class="font-bold">Wholesale Target</span><span class="font-bold">${fmtUSD(b.wholesaleTargetUSD)}</span></div>
            </div>
          </div>
        `;

        const dealBlock = `
          <div class="p-4 rounded-2xl border bg-white">
            <div class="text-lg font-bold text-gray-900 mb-3">Deal Analysis</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              <div class="flex justify-between"><span>Seller Asking</span><span class="font-semibold">${fmtUSD(d.askingPriceUSD)}</span></div>
              <div class="flex justify-between"><span>Transport Cost</span><span class="font-semibold">${fmtUSD(d.transportCostUSD)}</span></div>
              <div class="flex justify-between"><span>Reconditioning</span><span class="font-semibold">${fmtUSD(d.reconditioningUSD)}</span></div>
              <div class="flex justify-between"><span>Total Investment</span><span class="font-semibold">${fmtUSD(d.totalInvestmentUSD)}</span></div>
              <div class="flex justify-between"><span>Projected Retail</span><span class="font-semibold">${fmtUSD(b.projectedRetailUSD)}</span></div>
              <div class="flex justify-between"><span>Net Profit</span><span class="font-semibold">${fmtUSD(d.netProfitUSD)}</span></div>
              <div class="flex justify-between"><span>Profit Margin</span><span class="font-semibold">${(d.profitMarginPct==null ? "N/A" : (Math.round(d.profitMarginPct*1000)/10)+"%")}</span></div>
              <div class="flex justify-between"><span>Priority</span><span class="font-bold">${d.priorityScore ?? "N/A"} — ${d.priorityTier ?? ""}</span></div>
            </div>
            <div class="text-xs text-gray-500 mt-2">
              Priority weights: margin 40%, profit 30%, confidence 15%, velocity 10%, days-on-market 5%.
            </div>
          </div>
        `;

        const riskBlock = `
          <div class="p-4 rounded-2xl border bg-white">
            <div class="text-lg font-bold text-gray-900 mb-2">Risks & Notes</div>
            <div class="text-sm text-gray-700">${report.risks?.riskSummary ?? "No risk summary provided."}</div>
            <div class="mt-2">${notesList}</div>
          </div>
        `;

        const disclaimerBlock = `
          <div class="p-4 mt-2 bg-yellow-50 text-sm text-yellow-900 rounded-xl border border-yellow-100">
            <strong>Disclaimer:</strong> ${report.disclaimer ?? "This report is an estimate based on photos, notes, and grounded market data. Verify condition, title, and hours before purchase."}
          </div>
        `;

        reportContent.innerHTML = `
          ${declineBanner}
          ${flagBanner}
          ${idBlock}
          ${valuationBlock}
          ${breakdownTable}
          ${dealBlock}
          ${riskBlock}
          <div class="p-4 rounded-2xl border bg-gray-50">${sourcesHtml}</div>
          ${disclaimerBlock}
        `;

        reportContainer.style.display = 'block';
        downloadButton.classList.remove('hidden');

        showMessage("Report generated successfully! (Step 3/3 complete)", 'info');

        // Save to Firestore
        if (db && userId) {
          try {
            const reportRef = doc(db, `artifacts/${appId}/users/${userId}/reports/${Date.now()}`);
            await setDoc(reportRef, reportData);
          } catch (e) {
            console.error("Save failed:", e);
            showMessage("Report generated, but failed to save to database.", 'warning');
          }
        }

      } catch (err) {
        console.error(err);
        showMessage(`Failed to generate report: ${err.message}`, 'error');
        reportData = null;
      } finally {
        generateButton.disabled = false;
      }
    });

    // -------------------------
    // PDF download
    // -------------------------
    downloadButton.addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const reportElement = document.getElementById('report-container');
      if (!reportData) { showMessage("No report to download yet.", 'error'); return; }

      showMessage("Preparing PDF for download...", 'info');
      downloadButton.disabled = true;

      const addFooter = (doc, margin, pageHeight) => {
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.setFont("helvetica", "normal");
        doc.text("BonaFideIron.com", margin, pageHeight - 5);
      };

      try {
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 10;

        // Page 1: Report content
        const canvas = await html2canvas(reportElement, { scale: 2 });
        const imgData = canvas.toDataURL('image/jpeg', 0.85);
        const imgW = pageWidth - margin * 2;
        const imgH = (canvas.height * imgW) / canvas.width;
        doc.addImage(imgData, 'JPEG', margin, margin, imgW, imgH);
        addFooter(doc, margin, pageHeight);

        // Reference Images pages (smaller + lower-res)
        if (originalFiles.length) {
          doc.addPage();
          let y = margin;
          doc.setFontSize(16);
          doc.setTextColor(0);
          doc.text("Reference Images", margin, y);
          y += 10;
          addFooter(doc, margin, pageHeight);

          const imgTargetWidthMm = 76; // ~3 inches
          const pad = 6;
          const col2x = margin + imgTargetWidthMm + pad;

          for (let i = 0; i < originalFiles.length; i++) {
            const file = originalFiles[i];
            const r = new FileReader();
            r.readAsDataURL(file);
            await new Promise(res => r.onloadend = res);

            // lower-res in PDF
            const url = r.result;

            // Try to estimate height using an Image object
            const img = new Image();
            img.src = url;
            await new Promise(res => img.onload = res);
            const hMm = imgTargetWidthMm * (img.height / img.width);

            // new row every 2 images
            const isLeft = (i % 2 === 0);
            const x = isLeft ? margin : col2x;

            if (isLeft && i > 0) y += hMm + pad;

            // page break
            if (y + hMm > pageHeight - margin - 10) {
              doc.addPage();
              y = margin;
              doc.setFontSize(16);
              doc.text("Reference Images (Cont.)", margin, y);
              y += 10;
              addFooter(doc, margin, pageHeight);
            }

            doc.addImage(url, 'JPEG', x, y, imgTargetWidthMm, hMm, undefined, 'FAST');

            // if right column, don't advance; next left handles row advance
            if (!isLeft) {
              // keep y for next row advance
            }
          }
        }

        const make = reportData?.raw?.equipment?.make ?? "Equipment";
        const model = reportData?.raw?.equipment?.model ?? "Report";
        const dateStr = new Date().toISOString().split('T')[0];
        const fname = `${String(make).replace(/\s+/g,'_')}_${String(model).replace(/\s+/g,'_')}_${dateStr}_BFI_Report.pdf`;

        doc.save(fname);
        showMessage("PDF download started!", 'info');
      } catch (e) {
        console.error(e);
        showMessage("Failed to generate PDF. Please try again.", 'error');
      } finally {
        downloadButton.disabled = false;
      }
    });
  </script>
</body>
</html>
